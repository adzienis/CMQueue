<% options = {} if local_assigns[:options].nil? %>
<% options[:actions] ||= [] %>

<div class="card mb-3">
  <div class="card-body">
    <%= simple_form_for model_instance,
                        defaults: {
                          wrapper_html: {
                            class: "mb-2"
                          },
                          input_html: {
                            class: "mb-2" } } do |f| %>
      <fieldset disabled>
        <% model_instance.class.content_columns
                         .reject { |v| options&.dig(:except)&.include? v.name.to_sym }
                         .each do |col| %>
          <b>
            <%= f.input col.name, html5: true %>
          </b>
        <% end %>
        <% [:has_and_belongs_to_many]
             .collect { |s| model_instance.class.reflect_on_all_associations(s) }
             .flatten
             .reject { |v| [:courses, :roles, :enrollments, :question_states].include? v.name.to_sym }
             .each do |ass| %>
          <div>
            <label>
              <b>
                <%= ass.name.to_s.humanize %>
              </b>
            </label>
            <div>
              <% model_instance.send(ass.name.to_sym).accessible_by(current_ability).limit(5).each do |e| %>
                <%= link_to e.id,
                            polymorphic_path(
                              params[:course_id] ? [Course.find(params[:course_id]), e] : [e]) %>
              <% end %>
              <% if params[:course_id] %>
                <%= link_to "More", polymorphic_path([Course.find(params[:course_id]), ass.name],
                                                     { "q[#{model_instance.class.name.underscore}_id_eq]" => model_instance.id }) %>
              <% end %>
            </div>
          </div>
        <% end %>
        <% [:has_many]
             .collect { |s| model_instance.class.reflect_on_all_associations(s) }
             .flatten
             .reject { |v| [:courses, :roles, :enrollments, :question_states].include? v.name.to_sym }
             .each do |ass| %>
          <div>
            <label>
              <b>
                <%= ass.name.to_s.humanize %>
              </b>
            </label>
            <div>
              <% model_instance.send(ass.name.to_sym).accessible_by(current_ability).limit(5).each do |e| %>
                <%= link_to e.id,
                            polymorphic_path(
                              params[:course_id] ? [Course.find(params[:course_id]), e] : [e]) %>,
              <% end %>
              <% if params[:course_id] %>
                <%= link_to "More", polymorphic_path([Course.find(params[:course_id]), ass.name],
                                                     {
                                                       "q[#{ass.options.dig(:through) ? ass.options.dig(:through).to_s + '_' : ''}" +
                                                         "#{model_instance.class.name.underscore}_id_eq]" => model_instance.id }) %>
              <% end %>
            </div>
          </div>
        <% end %>
        <% [:has_one]
             .collect { |s| model_instance.class.reflect_on_all_associations(s) }
             .flatten
             .reject { |v| [:courses, :roles, :enrollments, :question_states].include? v.name.to_sym }
             .each do |ass| %>
          <div>
            <label>
              <b>
                <%= ass.name.to_s.humanize %>
              </b>
            </label>
            <div>
              <% Array(model_instance.send(ass.name.to_sym)).each do |e| %>
                <%= link_to e.id,
                            polymorphic_path(
                              params[:course_id] ? [Course.find(params[:course_id]), e] : [e]) %>
              <% end %>
            </div>
          </div>
        <% end %>
      </fieldset>
    <% end %>
  </div>
  <% if !options[:actions].empty? %>
    <div class="card-footer d-flex flex-row">
      <div class="flex-1"></div>
      <%= button_to "Edit", edit_polymorphic_path(model_instance), class: "btn btn-warning me-2", method: :get if options[:actions].include? :edit %>
      <%= button_to "Delete", polymorphic_path(model_instance), class: "btn btn-danger", method: :delete if options[:actions].include? :delete %>
    </div>
  <%end %>
</div>